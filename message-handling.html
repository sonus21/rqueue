<!DOCTYPE html>
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<link rel="stylesheet" href="/rqueue/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-HWK3PKDELN"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-HWK3PKDELN', { 'anonymize_ip': true }); </script> <script src="/rqueue/assets/js/vendor/lunr.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script> <script src="/rqueue/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/rqueue/static/favicon/favicon.ico" type="image/x-icon">
<title>Message Handling | Rqueue</title>
<meta name="generator" content="Jekyll v4.3.2">
<meta property="og:title" content="Message Handling">
<meta property="og:locale" content="en_US">
<meta name="description" content="Message Handling in Rqueue">
<meta property="og:description" content="Message Handling in Rqueue">
<link rel="canonical" href="https://sonus21.github.io/rqueue/rqueue/message-handling">
<meta property="og:url" content="https://sonus21.github.io/rqueue/rqueue/message-handling">
<meta property="og:site_name" content="Rqueue">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Message Handling"> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Message Handling in Rqueue","headline":"Message Handling","url":"https://sonus21.github.io/rqueue/rqueue/message-handling"}</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9220054661402722" crossorigin="anonymous"></script>
</head>
<body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewbox="0 0 24 24"><title>Link</title>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"><title>Menu</title>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"><title>Expand</title>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title>
<path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"><title>Document</title>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"><title>Search</title>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewbox="0 0 16 16"><title>Copy</title>
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewbox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path> </svg> </symbol> <symbol id="svg-copied" viewbox="0 0 16 16"><title>Copied</title>
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewbox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"></path><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"></path> </svg> </symbol> </svg><div class="side-bar">
<div class="site-header"> <a href="/rqueue/" class="site-title lh-tight"> Rqueue </a> <a href="#" id="menu-button" class="site-button"> <svg viewbox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a>
</div>
<nav aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list">
<li class="nav-list-item"><a href="/rqueue/" class="nav-list-link">Home</a></li>
<li class="nav-list-item">
<a href="#" class="nav-list-expander" aria-label="toggle links in Configuration category"> <svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/rqueue/configuration" class="nav-list-link">Configuration</a><ul class="nav-list">
<li class="nav-list-item "><a href="/rqueue/configuration/redis-configuration/" class="nav-list-link">Redis Configuration</a></li>
<li class="nav-list-item "><a href="/rqueue/configuration/retry-and-backoff/" class="nav-list-link">Retry and Backoff</a></li>
</ul>
</li>
<li class="nav-list-item active">
<a href="#" class="nav-list-expander" aria-label="toggle links in Producer Consumer category"> <svg viewbox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/rqueue/producer-consumer" class="nav-list-link">Producer Consumer</a><ul class="nav-list">
<li class="nav-list-item active"><a href="/rqueue/message-handling" class="nav-list-link active">Message Handling</a></li>
<li class="nav-list-item "><a href="/rqueue/message-deduplication" class="nav-list-link">Message Deduplication</a></li>
<li class="nav-list-item "><a href="/rqueue/middleware" class="nav-list-link">Middleware</a></li>
<li class="nav-list-item "><a href="/rqueue/priority" class="nav-list-link">Queue Priority</a></li>
</ul>
</li>
<li class="nav-list-item"><a href="/rqueue/callback-and-events" class="nav-list-link">Callbacks and Events</a></li>
<li class="nav-list-item"><a href="/rqueue/dashboard" class="nav-list-link">Rqueue Dashboard</a></li>
<li class="nav-list-item"><a href="/rqueue/monitoring-alerting" class="nav-list-link">Monitoring and Alerting</a></li>
<li class="nav-list-item"><a href="/rqueue/faq" class="nav-list-link">FAQ</a></li>
<li class="nav-list-item"><a href="/rqueue/CHANGELOG/" class="nav-list-link">CHANGELOG</a></li>
<li class="nav-list-item"><a href="/rqueue/migration" class="nav-list-link">Migration from older to new version</a></li>
</ul>
<ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/sonus21/rqueue" class="nav-list-link external"> Rqueue on GitHub <svg viewbox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a>
</li></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer>
</div>
<div class="main" id="top">
<div id="main-header" class="main-header">
<div class="search">
<div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Rqueue" aria-label="Search Rqueue" autocomplete="off"> <label for="search-input" class="search-label"><svg viewbox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label>
</div>
<div id="search-results" class="search-results"></div>
</div>
<nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="//github.com/sonus21/rqueue" class="site-button"> Rqueue on GitHub </a>
</li></ul></nav>
</div>
<div id="main-content-wrap" class="main-content-wrap">
<nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list">
<li class="breadcrumb-nav-list-item"><a href="/rqueue/producer-consumer">Producer Consumer</a></li>
<li class="breadcrumb-nav-list-item"><span>Message Handling</span></li>
</ol></nav><div id="main-content" class="main-content" role="main">
<p>Rqueue supports two types of message handling</p>
<ul>
<li>Unicast: One message is handed over to one the listener/handler/consumer</li>
<li>Multicast: One message is handed over to multiple listeners/handlers/consumers</li>
</ul>
<p><a href="https://raw.githubusercontent.com/sonus21/rqueue/master/docs/static/qrqueue-message-flow.jpg"><img src="https://raw.githubusercontent.com/sonus21/rqueue/master/docs/static/rqueue-message-flow.jpg" alt="Message Handling"></a></p>
<h2 id="message-multicasting"> <a href="#message-multicasting" class="anchor-heading" aria-labelledby="message-multicasting"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Message Multicasting</h2>
<p>When multiple listeners are attached to the same queue, it’s essential to designate one as the primary listener. This primary listener handles retries and other operations related to message processing. Secondary listeners are invoked alongside the primary listener whenever a message is received. For example, if three listeners (<code class="language-plaintext highlighter-rouge">L1</code>, <code class="language-plaintext highlighter-rouge">L2</code>, and <code class="language-plaintext highlighter-rouge">L3</code>) are registered for the <code class="language-plaintext highlighter-rouge">user-queue</code>, one of them must be designated as primary.</p>
<p>Designating a primary listener means that if the primary listener (<code class="language-plaintext highlighter-rouge">L2</code>, in this example) encounters a processing failure, it retries the message. During retries, all listeners (<code class="language-plaintext highlighter-rouge">L1</code>, <code class="language-plaintext highlighter-rouge">L3</code>, and <code class="language-plaintext highlighter-rouge">L2</code>) might be called again with the same message (<code class="language-plaintext highlighter-rouge">UserEvent1</code>), potentially leading to duplicate processing for some listeners (<code class="language-plaintext highlighter-rouge">L1</code> and <code class="language-plaintext highlighter-rouge">L3</code>), even if they successfully processed the event initially.</p>
<h2 id="configuration"> <a href="#configuration" class="anchor-heading" aria-labelledby="configuration"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuration</h2>
<p>Add <code class="language-plaintext highlighter-rouge">RqueueListener</code> annotation to any class, and use any of the spring stereotype annotation, so that a bean would be created. Annotate all listener methods in this class using <code class="language-plaintext highlighter-rouge">RqueueHandler</code></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nd">@RqueueListener</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"${user.banned.queue.name}"</span><span class="o">,</span> <span class="n">active</span> <span class="o">=</span> <span class="s">"${user.banned.queue.active}"</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserBannedMessageListener</span> <span class="o">{</span>

  <span class="nd">@NonNull</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ConsumedMessageStore</span> <span class="n">consumedMessageStore</span><span class="o">;</span>

  <span class="nd">@Value</span><span class="o">(</span><span class="s">"${user.banned.queue.name}"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">userBannedQueue</span><span class="o">;</span>

  <span class="nd">@RqueueHandler</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage1</span><span class="o">(</span><span class="nc">UserBanned</span> <span class="n">userBanned</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JsonProcessingException</span> <span class="o">{</span>
    <span class="n">consumedMessageStore</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">userBanned</span><span class="o">,</span> <span class="s">"handleMessage1"</span><span class="o">,</span> <span class="n">userBannedQueue</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"handleMessage1 {}"</span><span class="o">,</span> <span class="n">userBanned</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@RqueueHandler</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage2</span><span class="o">(</span><span class="nc">UserBanned</span> <span class="n">userBanned</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JsonProcessingException</span> <span class="o">{</span>
    <span class="n">consumedMessageStore</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">userBanned</span><span class="o">,</span> <span class="s">"handleMessage2"</span><span class="o">,</span> <span class="n">userBannedQueue</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"handleMessage2 {}"</span><span class="o">,</span> <span class="n">userBanned</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@RqueueHandler</span><span class="o">(</span><span class="n">primary</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessagePrimary</span><span class="o">(</span><span class="nc">UserBanned</span> <span class="n">userBanned</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JsonProcessingException</span> <span class="o">{</span>
    <span class="n">consumedMessageStore</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">userBanned</span><span class="o">,</span> <span class="s">"handleMessagePrimary"</span><span class="o">,</span> <span class="n">userBannedQueue</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"handleMessagePrimary {}"</span><span class="o">,</span> <span class="n">userBanned</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@RqueueHandler</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleUserBanned</span><span class="o">(</span><span class="nc">UserBanned</span> <span class="n">userBanned</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JsonProcessingException</span> <span class="o">{</span>
    <span class="n">consumedMessageStore</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">userBanned</span><span class="o">,</span> <span class="s">"handleUserBanned"</span><span class="o">,</span> <span class="n">userBannedQueue</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"handleUserBanned {}"</span><span class="o">,</span> <span class="n">userBanned</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<h2 id="limitation"> <a href="#limitation" class="anchor-heading" aria-labelledby="limitation"><svg viewbox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Limitation</h2>
<ul>
<li><p><strong>Middleware</strong>: Middlewares are invoked globally before any handler method is called. They are not called individually for each handler. It’s crucial that message release is only handled by the primary handler to avoid inconsistent states.</p></li>
<li><p><strong>Failure/Retry</strong>: Failure and retry mechanisms apply exclusively to the primary handler. If the primary handler fails during execution, all handlers will be retried in the subsequent attempt.</p></li>
<li><p><strong>Metrics/Job data</strong>: Metrics and job data are recorded once per execution cycle. For instance, even if there are multiple handlers configured, such as four in this example, it will count as a single execution generating a single job record.</p></li>
</ul>
<hr>
<footer><p><a href="#top" id="back-to-top">Back to top</a></p>Copyright © 2019-2024 Sonu Kumar. Distributed by an <a href="https://github.com/sonus21/rqueue/tree/main/LICENSE">Apache 2.0 license.</a> Build on 2024-07-09 03:58<div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/sonus21/rqueue/tree/main/message-handling/message-handling.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer>
</div>
</div>
<div class="search-overlay"></div>
</div>
<script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script>
</body>
</html>
